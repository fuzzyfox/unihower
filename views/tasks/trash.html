{% extends '_default.html' %}

{% block main %}
<div class="container">
  <nav>
    <ol class="breadcrumb">
      {% if topicId and tasks.length %}
      <li><a href="/topics/{{ topicId }}">{{ tasks[ 0 ].Topic.name }}</a></li>
      {% else %}
      <li><a href="/tasks">All Tasks</a></li>
      {% endif %}
      <li class="active"><i class="fa fa-trash"></i> Trashed Tasks</li>
    </ol>
  </nav>

  <h3>Trashed Tasks</h3>
  <div class="row">
    <div class="col-md-6">
      <div class="eisenhower-graph" data-graph-size="500" data-tasks-url="/api/users/{{ user.id }}/tasks?showDeleted=1" data-trash-only="true"></div>
    </div>
    <div class="col-md-6">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>state</th>
            <th>description</th>
            <th>due date</th>
            {% if not topicId %}
            <th>topic</th>
            {% endif %}
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for task in tasks %}
          <tr rel="task-{{ task.id }}">
            <td>{{ task.state }}</td>
            <td>{{ task.description if task.description }}</td>
            <td>{{ task.dueDate | calendar if task.dueDate else '-' }}</td>
            {% if not topicId %}
            <td>
              {% if task.Topic %}
              <a href="/topics/{{ task.TopicId }}">{{ task.Topic.name }}</a>
              {% else %}
              â€“
              {% endif %}
            </td>
            {% endif %}
            <td>
              <div class="btn-group pull-right">
                <a href="#restore-{{ task.id }}" class="btn btn-sm btn-success" data-task="{{ task.id }}">
                  <i class="fa fa-refresh"></i> Restore
                </a>
                <a href="#delete-{{ task.id }}" class="btn btn-sm btn-danger" data-task="{{ task.id }}">
                  <i class="fa fa-trash"></i> Delete
                </a>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      {% if tasks.length < 1 %}
      <div class="alert alert-info">
        <p><i class="fa fa-info-circle"></i> You have no tasks in the trash.</p>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block custom_scripts %}
<script src="/assets/js/graph.js"></script>
<script>
  $( function() {
    function ajaxFailHandler( jqXHR ) {
      if( jqXHR.responseJSON ) {
        if( typeof jqXHR.responseJSON.message === 'string' ) {
          window.alert( jqXHR.responseJSON.status + '\n\n' + jqXHR.responseJSON.message );
        }

        window.alert( jqXHR.responseJSON.status + '\n\nWe\'ve made a note of the problem and will get it fixed as soon as possible.' );
        return console.log( arguments );
      }

      window.alert( 'An unknown error occured... try again later' );
    };

    $( 'a[href^="#delete-"]' ).on( 'click', function() {

      if( window.confirm( 'Are you sure you want to delete this task? This action cannot be undone.' ) ) {
        $.ajax({
          method: 'DELETE',
          url: '/api/tasks/' + $( this ).data( 'task' ) + '?force=1',
          data: {
            _csrf: '{{ csrfToken }}'
          },
          dataType: 'json'
        }).done( function() {
          {% if tasks.length == 1 %}
          window.location.href = '/topics/{{ topicId }}';
          {% else %}
          window.location.reload();
          {% endif %}
        }).fail( ajaxFailHandler );
      }

      return false;
    });

    $( 'a[href^="#restore-"]' ).on( 'click', function() {

      $.ajax({
        method: 'PUT',
        url: '/api/tasks/' + $( this ).data( 'task' ),
        data: {
          _csrf: '{{ csrfToken }}',
          deletedAt: null
        },
        dataType: 'json'
      }).done( function() {
        {% if tasks.length == 1 %}
        window.location.href = '/topics/{{ topicId }}';
        {% else %}
        window.location.reload();
        {% endif %}
      }).fail( ajaxFailHandler );

      return false;
    });
  });
</script>
{% endblock %}
